
rules_version = '2';

service cloud.firestore {
  // --- Helper Functions ---
  function isAuthed() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isAuthed() && request.auth.uid == userId;
  }

  function hasValidUserId(userId) {
    return request.resource.data.userId is string && request.resource.data.userId == userId;
  }

  function isMaintainingOwnership() {
    return resource.data.userId == request.resource.data.userId;
  }

  match /databases/{database}/documents {

    // --- User Profile (Private) ---
    match /users/{userId} {
      allow get, update, delete: if isOwner(userId);
      allow create: if isAuthed();
      allow list: if false;
    }

    // --- Plans Subcollection (Private) ---
    match /users/{userId}/plans/{planId} {
      allow get, list, delete: if isOwner(userId);
      allow create: if isOwner(userId) && hasValidUserId(userId);
      allow update: if isOwner(userId) && isMaintainingOwnership() && hasValidUserId(userId);
    }

    // --- Itineraries Subcollection (Private) ---
    match /users/{userId}/itineraries/{itineraryId} {
      allow get, list, delete: if isOwner(userId);
      allow create: if isOwner(userId) && hasValidUserId(userId);
      allow update: if isOwner(userId) && isMaintainingOwnership() && hasValidUserId(userId);
    }

    // --- Shared Plans (Public) ---
    match /shared_plans/{planId} {
      // Allow anyone to read the shared plan
      allow get: if true;

      // Only the original owner can create, update, or delete the shared copy
      allow create, update, delete: if isOwner(request.resource.data.userId);
    }

    // --- Shared Itineraries (Public) ---
    match /shared_itineraries/{itineraryId} {
      // Allow anyone to read the shared itinerary
      allow get: if true;

      // Only the original owner can create, update, or delete the shared copy
      allow create, update, delete: if isOwner(request.resource.data.userId);
    }
  }
}
